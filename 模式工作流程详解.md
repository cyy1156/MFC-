# 实时模式与仿真模式工作流程详解

## 概述
该系统支持两种工作模式：**实时模式**（Real-Time Mode）和**仿真模式**（Simulation Mode），通过 `m_bRealTime` 标志控制。实时模式从硬件设备获取数据，仿真模式使用数学模型模拟过程。两种模式共享相同的控制算法和UI更新逻辑，但数据来源不同。

## 关键变量
- `m_bRealTime`: 模式标志（TRUE=实时，FALSE=仿真，默认FALSE）。
- `m_SysInfo.CurrentValue`: 当前采样值。
- `m_OutPredictArray`: 预测输出数组（用于仿真）。
- `m_DataAqisit`: 数据采集对象（用于实时）。

## 实时模式工作流程

### 1. 初始化
- 在 `Start()` 方法中，设置 `m_bRealTime = TRUE`（假设外部配置）。
- 初始化控制算法（如PID、预测控制）。
- 重置计数器和数组。

### 2. 采样阶段（Sample()）
```cpp
if(m_bRealTime)
    m_SysInfo.CurrentValue = m_DataAqisit.DoSampl();  // 从硬件设备采样
```
- 调用 `m_DataAqisit.DoSampl()` 获取传感器或数据采集卡的实际数据。
- 计算最大输出值和超调量。
- 更新采样值列表：`m_pSamplValueList->SetData((void*)&m_SysInfo.CurrentValue)`。
- 设置 `m_SampleFlag = TRUE`。

### 3. 数组更新阶段（UpdateOutArray()）
- 检查 `m_SampleFlag`，如果为TRUE，重置标志。
- 由于实时模式，不进行预测更新。
- 将当前值和控制值添加到显示数组（`m_OutArray` 和 `m_CtrlArray`）。
- 如果数组过长，移除旧数据。

### 4. 控制计算阶段（Control()）
- 根据 `m_Algrithem` 调用相应算法（如 `m_Predict.OutValueCalculate()`）。
- 计算控制输出：`m_SysInfo.CurrentControl`。
- 更新控制值列表：`m_pCtrlValueList->SetData((void*)&m_SysInfo.CurrentControl)`。

### 5. 循环执行
- 采样、控制、UI更新循环进行，直到停止。
- 数据实时反映硬件状态。

## 仿真模式工作流程

### 1. 初始化
- `m_bRealTime = FALSE`（默认）。
- 在 `Start()` 中，初始化预测数组：`m_OutPredictArray[i] = 0.f`。
- 启动控制算法。

### 2. 采样阶段（Sample()）
```cpp
else
    m_SysInfo.CurrentValue = m_OutPredictArray[0];  // 从预测数组取值
```
- 从 `m_OutPredictArray[0]` 获取当前值（模拟采样）。
- 计算最大输出和超调。
- 更新采样列表。
- 设置 `m_SampleFlag = TRUE`。

### 3. 数组更新阶段（UpdateOutArray()）
- 重置 `m_SampleFlag`。
- **预测更新**（关键区别）：
  ```cpp
  if(!m_bRealTime) {
      if(m_ControlCounter == 1) {  // 控制有作用
          for(i=0; i<m_ModelLenth-1; i++)
              m_OutPredictArray[i] = m_OutPredictArray[i+1] + m_ObjectModel.m_ModelArray[i] * DeltaControl;
          m_OutPredictArray[i] += m_ObjectModel.m_ModelArray[i] * DeltaControl;
      } else {  // 控制无作用
          for(i=0; i<m_ModelLenth-1; i++)
              m_OutPredictArray[i] = m_OutPredictArray[i+1];
      }
  }
  ```
  - 使用对象模型（`m_ObjectModel`）和控制增量（`DeltaControl`）预测未来输出。
- 添加到显示数组。

### 4. 控制计算阶段（Control()）
- 同实时模式，调用算法计算控制值。
- 控制输出影响下次预测。

### 5. 循环执行
- 采样（从预测取值）、预测更新、控制计算循环。
- 模拟控制过程，无需硬件。

## 两种模式的区别

| 方面          | 实时模式                          | 仿真模式                          |
|---------------|-----------------------------------|-----------------------------------|
| 数据来源      | 硬件设备（传感器等）              | 数学模型预测                      |
| 采样方法      | `m_DataAqisit.DoSampl()`          | `m_OutPredictArray[0]`            |
| 预测更新      | 无                                | 有（使用对象模型）                |
| 适用场景      | 实际控制系统                      | 算法测试、离线仿真                |
| 实时性        | 高（依赖硬件响应）                | 低（软件模拟）                    |

## 控制算法集成
- 两种模式都支持多种算法：PID、预测控制、自适应等。
- 在 `Control()` 中根据 `m_Algrithem` 选择算法。
- 算法计算 `m_SysInfo.CurrentControl`，影响系统行为。

## UI更新
- 两种模式都通过 `UpdateClients()` 广播消息。
- 视图更新显示值、趋势图等。

## 总结
- **实时模式**：真实数据驱动，适用于生产环境。
- **仿真模式**：模型驱动，便于开发和测试。
- 系统设计灵活，支持无缝切换模式。